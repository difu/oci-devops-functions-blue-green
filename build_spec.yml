version: 0.1             
component: build
timeoutInSeconds: 1000
shell: bash

env:
  exportedVariables:
    - buildId
    - commitId
    - timestamp

steps:
  - type: Command
    command: |
      buildId=`echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-6 | rev`
      echo "Build ID: $buildId"
      commitId=`echo ${OCI_TRIGGER_COMMIT_HASH} | rev | cut -c 1-6 | rev`
      echo "Commit ID: $commitId"
      timestamp=`date +%s`
      echo "Timestamp: $timestamp"
  - type: Command
    command: |
      cd functions/api-retriever
      fn build --verbose
      image=$(docker images | grep api-retriever | awk -F ' ' '{print $3}')
      docker tag $image eu-frankfurt-1.ocir.io/frsxwtjslf35/dwd/api-retriever:latest
      docker tag $image eu-frankfurt-1.ocir.io/frsxwtjslf35/dwd/api-retriever:$buildId

outputArtifacts:
  - name: api-retriever
    type: DOCKER_IMAGE
    location: eu-frankfurt-1.ocir.io/frsxwtjslf35/dwd/api-retriever
  - name: fn-integration-payload
    type: BINARY
    location: ${OCI_PRIMARY_SOURCE_DIR}/functions/devops-resource-manager-trigger/payload.json